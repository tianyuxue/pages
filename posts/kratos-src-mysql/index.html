<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Kratos 源码分析 - MySQL部分 | ACoder</title><meta name=keywords content="kratos,mysql">
<meta name=description content="
本文的讨论基于Kratos v1.0.x版本

Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与MySQL相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述（这篇文章没有复杂的原理，只有从工程角度的一些最佳实践)。">
<meta name=author content="jitianyu">
<link rel=canonical href=https://tianyuxue.github.io/posts/kratos-src-mysql/>
<meta name=google-site-verification content="G-0T00DX73T1">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=preload href=images/code.png as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://tianyuxue.github.io/images/code.png>
<link rel=icon type=image/png sizes=16x16 href=https://tianyuxue.github.io/images/code.png>
<link rel=icon type=image/png sizes=32x32 href=https://tianyuxue.github.io/images/code.png>
<link rel=apple-touch-icon href=https://tianyuxue.github.io/images/code.png>
<link rel=mask-icon href=https://tianyuxue.github.io/images/code.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-0T00DX73T1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0T00DX73T1",{anonymize_ip:!1})}</script>
<meta property="og:title" content="Kratos 源码分析 - MySQL部分">
<meta property="og:description" content="
本文的讨论基于Kratos v1.0.x版本

Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与MySQL相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述（这篇文章没有复杂的原理，只有从工程角度的一些最佳实践)。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://tianyuxue.github.io/posts/kratos-src-mysql/">
<meta property="og:image" content="https://tianyuxue.github.io/images/mountain.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-01-07T00:00:00+00:00">
<meta property="article:modified_time" content="2021-01-07T00:00:00+00:00"><meta property="og:site_name" content="ACoder">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://tianyuxue.github.io/images/mountain.jpg">
<meta name=twitter:title content="Kratos 源码分析 - MySQL部分">
<meta name=twitter:description content="
本文的讨论基于Kratos v1.0.x版本

Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与MySQL相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述（这篇文章没有复杂的原理，只有从工程角度的一些最佳实践)。">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tianyuxue.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Kratos 源码分析 - MySQL部分","item":"https://tianyuxue.github.io/posts/kratos-src-mysql/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kratos 源码分析 - MySQL部分","name":"Kratos 源码分析 - MySQL部分","description":" 本文的讨论基于Kratos v1.0.x版本\n Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与MySQL相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述（这篇文章没有复杂的原理，只有从工程角度的一些最佳实践)。\n","keywords":["kratos","mysql"],"articleBody":" 本文的讨论基于Kratos v1.0.x版本\n Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与MySQL相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述（这篇文章没有复杂的原理，只有从工程角度的一些最佳实践)。\n1 核心对象的封装 Kratos的数据层代码主要是对Golang SDK的二次封装。在GolangSDK中，database/sql包提供了对SQL的支持，具体而言，这个包提供了如下的抽象：\n DB 抽象表示数据库本身，也可以将其理解为数据库连接池 Conn 抽象表示单独一个数据库连接 Tx 抽象表示一次数据库事务操作 Stmt 抽象表示一个Prepared Statement Row/Rows 抽象表示一次数据库交互后的结果  database/sql包提供的这些抽象接口是直观的，易用的，足够应付简单的应用场景。Kratos对上面这几个对象再次进行了封装，提供了实际开发中经常用到的如下功能：\n MySQL读写分离 链路追踪 统计信息 慢查询日志记录 融断保护  下面我从代码的角度分析下Kratos是如何实现上述功能的。\n2 功能点的实现 2.1 MySQL读写分离 Kratos从DAO层的代码层面实现了对MySQL读写分离的支持，并未使用数据库中间件。首先看下Kratos需要用户提供的MySQL集群配置信息：\n1 2 3 4 5 6 7 8 9 10 11 12  pkg/database/sql/mysql.go type Config struct {  DSN string // write data source name.  ReadDSN []string // read data source name  Active int // pool  Idle int // pool  IdleTimeout time.Duration // connect max life time.  QueryTimeout time.Duration // query sql timeout  ExecTimeout time.Duration // execute sql timeout  TranTimeout time.Duration // transaction sql timeout  Breaker *breaker.Config // breaker }   可以看出，DSN和ReadDSN分别存储了MySQL主节点地址和从节点地址，从节点地址有多个。Kratos会根据上述配置，生成如下的连接池对象：\n1 2 3 4 5 6  type DB struct { write *conn //主节点连接池，conn定义见下文 read []*conn //从节点连接池 idx int64 // 用于选取从节点的id master *DB //MySQL的主节点 }   DB对象使用master字段冗余存储主节点的信息，用来支持一些特定业务场景下，必须查询主库的操作。write/read字段分别表示数据库具体连接池，从conn类型的定义可以看到，其内部封装了Golang SDK中的 sql.DB对象：\n1 2 3 4 5 6 7  // conn database connection type conn struct {  *sql.DB // 对Golang SDK连接池的封装，用来支持MySQL读写分离  breaker breaker.Breaker  conf *Config  addr string }   这样通过把Golang SDK中的sql.DB嵌入到conn对象中，再把多个conn对象封装到DB对象中，就使Kratos的DB对象支持了对MySQL集群的多个实例的读写。下面是Kratos中查询从库的方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  // Query executes a query that returns rows, typically a SELECT. The args are // for any placeholder parameters in the query. func (db *DB) Query(c context.Context, query string, args ...interface{}) (rows *Rows, err error) {  // 获取要读取哪一个从库 \tidx := db.readIndex() \tfor i := range db.read { \t// 依次尝试每一个从库, 只要一个成功了就返回 \tif rows, err = db.read[(idx+i)%len(db.read)].query(c, query, args...); !ecode.EqualError(ecode.ServiceUnavailable, err) { \treturn \t} \t} \t// 从库失败了的话就查询主库 \treturn db.write.query(c, query, args...) }  ...  // 简单的使用轮询策略选择要读取的从库 func (db *DB) readIndex() int { \tif len(db.read) == 0 { \treturn 0 \t} \tv := atomic.AddInt64(\u0026db.idx, 1) \treturn int(v) % len(db.read) }   从readIndex()方法中可以看到，Kratos在查询从库时候使用了简单轮寻的方法，每次查询前使用cas方式将内部变量idx自增，然后通过取mod的方式确定要查询哪一个从库。Query()方法中循环尝试读取每一个从库，只有读取成功了一次后才返回，这样避免了个别从库故障导致的读取失败。\n除了读操作之外，对于写入的操作，Kratos同样对Golang SDK中sql.DB的如下方法进行了封装：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // 启动MySQL事务 func (db *DB) Begin(c context.Context) (tx *Tx, err error) { \treturn db.write.begin(c) }  // 执行无返回结果的SQL语句 func (db *DB) Exec(c context.Context, query string, args ...interface{}) (res sql.Result, err error) { \treturn db.write.exec(c, query, args...) }  // 创建Prepared Statement，如果出错会返回错误信息 func (db *DB) Prepare(query string) (*Stmt, error) { \treturn db.write.prepare(query) }  // 创建Prepared Statement，如果出错会后台重试 func (db *DB) Prepared(query string) (stmt *Stmt) { \treturn db.write.prepared(query) }   通过上述几个方法的封装，Kratos直接使用主库的数据库连接池进行插入删除等操作。这样Kratos在DAO的代码层面实现对Golang原生database/sql包的封装。\n再看一下prepare statement的创建, Kratos的提供了Prepared()方法，如果创建prepare statement错误，那么启动一个goroutine不断重试，直到创建成功了，就用cas方法把prepare statement存储在Kratos封装的Stmt对象中， 个人感觉这样不够优雅，不知道b站内部是怎么用这个方法的：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45  // Stmt prepared stmt. type Stmt struct { \tdb *conn \ttx bool \tquery string \tstmt atomic.Value // 存储创建好的prepare statement \tt trace.Trace }  ...  func (db *conn) prepare(query string) (*Stmt, error) { \tdefer slowLog(fmt.Sprintf(\"Prepare query(%s)\", query), time.Now()) \tstmt, err := db.Prepare(query) \tif err != nil { \terr = errors.Wrapf(err, \"prepare %s\", query) \treturn nil, err \t} \tst := \u0026Stmt{query: query, db: db} \tst.stmt.Store(stmt) \treturn st, nil }  func (db *conn) prepared(query string) (stmt *Stmt) { \tdefer slowLog(fmt.Sprintf(\"Prepared query(%s)\", query), time.Now()) \tstmt = \u0026Stmt{query: query, db: db} \ts, err := db.Prepare(query) \tif err == nil { \tstmt.stmt.Store(s) \treturn \t} \t// 如果执行创建prepare出错了，这里后台执行不断重试，直到成功为止 \tgo func() { \tfor { \ts, err := db.Prepare(query) \tif err != nil { \ttime.Sleep(time.Second) \tcontinue \t} \tstmt.stmt.Store(s) \treturn \t} \t}() \treturn }   除了MySQL读写分离，Kratos对其他方法的封装主要是为了提供慢查询日志，trace日志，监控信息和熔断保护这四个功能。\n2.2 慢查询日志 Kratos在每个与数据库交互方法中记录了慢查询日志，结合关键字defer，其实现方法非常简单：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  ... func (db *conn) Query(c context.Context) (tx *Tx, err error) { \t// 获取当前时间，通过defer来确定结束时间  now := time.Now() \tdefer slowLog(\"Begin\", now)  ...  // 时间超过阈值，就打印一条警告记录 func slowLog(statement string, now time.Time) { \tdu := time.Since(now) \tif du  _slowLogDuration { \tlog.Warn(\"%s slow log statement: %s time: %v\", _family, statement, du) \t} }   与数据库交互的每个方法中，Kratos都加入了上述代码片段记录慢查询的警告日志。\n2.3 监控信息 在数据库链接层面，Kratos封装了prometheus客户端代码，提供了4个主要的监控信息：\n 请求处理时长 错误请求数 数据库连接总数 当前数据库连接数  具体的代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  pkg/database/sql/metrics.go  package sql  import \"github.com/go-kratos/kratos/pkg/stat/metric\"  const namespace = \"mysql_client\"  var ( \t_metricReqDur = metric.NewHistogramVec(\u0026metric.HistogramVecOpts{ \tNamespace: namespace, \tSubsystem: \"requests\", \tName: \"duration_ms\", \tHelp: \"mysql client requests duration(ms).\", \tLabels: []string{\"name\", \"addr\", \"command\"}, \tBuckets: []float64{5, 10, 25, 50, 100, 250, 500, 1000, 2500}, \t}) \t_metricReqErr = metric.NewCounterVec(\u0026metric.CounterVecOpts{ \tNamespace: namespace, \tSubsystem: \"requests\", \tName: \"error_total\", \tHelp: \"mysql client requests error count.\", \tLabels: []string{\"name\", \"addr\", \"command\", \"error\"}, \t}) \t_metricConnTotal = metric.NewCounterVec(\u0026metric.CounterVecOpts{ \tNamespace: namespace, \tSubsystem: \"connections\", \tName: \"total\", \tHelp: \"mysql client connections total count.\", \tLabels: []string{\"name\", \"addr\", \"state\"}, \t}) \t_metricConnCurrent = metric.NewGaugeVec(\u0026metric.GaugeVecOpts{ \tNamespace: namespace, \tSubsystem: \"connections\", \tName: \"current\", \tHelp: \"mysql client connections current.\", \tLabels: []string{\"name\", \"addr\", \"state\"}, \t}) )   Kratos已经把上面监控数据嵌入在封装好的数据库交互的方法中，例如数据库读写发生错误后会调用_metricReqErr.Inc(), 读写完成后会调用_metricReqDur.Observe()。\n2.4 断路器 Kratos的DB对象内置了断路器，存储在DB对象的breaker字段中，断路器的接口很简单，主要提供了如下三个方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  // Breaker 定义了断路器接口 type Breaker interface { \tAllow() error \tMarkSuccess() \tMarkFailed() }  ... //在连接发出请求前判断熔断器状态 if err = conn.breaker.Allow(); err != nil {  return }  //连接执行成功或失败将结果告知breaker if(respErr != nil){  conn.breaker.MarkFailed() }else{  conn.breaker.MarkSuccess() }  Kratos在与数据库交互前会检查断路器状态，执行完SQL语句后更新断路器状态，例如在exec()方法中：  func (db *conn) exec(c context.Context, query string, args ...interface{}) (res sql.Result, err error) {  ...  // 执行方法前确认断路器状态 \tif err = db.breaker.Allow(); err != nil { \t_metricReqErr.Inc(db.addr, db.addr, \"exec\", \"breaker\") \treturn \t} \t_, c, cancel := db.conf.ExecTimeout.Shrink(c) \tres, err = db.ExecContext(c, query, args...) \tcancel()  // 方法执行完毕后更新断路器状态 \tdb.onBreaker(\u0026err) \t_metricReqDur.Observe(int64(time.Since(now)/time.Millisecond), db.addr, db.addr, \"exec\") \tif err != nil { \terr = errors.Wrapf(err, \"exec:%s, args:%+v\", query, args) \t} \treturn }   2.5 trace信息 Kratos通过context来传递trace信息，见如下代码：\n1 2 3 4 5  if t, ok := trace.FromContext(c); ok {  t = t.Fork(_family, \"exec\") \tt.SetTag(trace.String(trace.TagAddress, db.addr), trace.String(trace.TagComment, query)) \tdefer t.Finish(\u0026amp;err) }   在从context获取了trace的记录单元后，同样使用了defer关键字记录了日志的终止信息。上述代码片段在每一个数据库交互方法中都存在，这样就实现了在读写数据库层面的trace信息记录。\n3 总结 本文从源码层面讨论了Kratos框架对读写MySQL提供的一些工程上的最佳实践。\n","wordCount":"925","inLanguage":"en","image":"https://tianyuxue.github.io/images/mountain.jpg","datePublished":"2021-01-07T00:00:00Z","dateModified":"2021-01-07T00:00:00Z","author":{"@type":"Person","name":"jitianyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tianyuxue.github.io/posts/kratos-src-mysql/"},"publisher":{"@type":"Organization","name":"ACoder","logo":{"@type":"ImageObject","url":"https://tianyuxue.github.io/images/code.png"}}}</script>
</head><body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://tianyuxue.github.io/ accesskey=h title="ACoder (Alt + H)">
<img src=https://tianyuxue.github.io/images/code.png alt=logo aria-label=logo height=35>ACoder</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div><ul id=menu>
<li>
<a href=https://tianyuxue.github.io/search/ title="搜索 (Alt + /)" accesskey=/>
<span>搜索</span>
</a>
</li><li>
<a href=https://tianyuxue.github.io/posts/ title=文章>
<span>文章</span>
</a>
</li><li>
<a href=https://tianyuxue.github.io/categories/ title=分类>
<span>分类</span>
</a>
</li><li>
<a href=https://tianyuxue.github.io/tags/ title=标签>
<span>标签</span>
</a>
</li><li>
<a href=https://tianyuxue.github.io/about/ title=关于我>
<span><i class="fa fa-heart"></i>关于我</span>
</a>
</li><li>
<a href=https://tianyuxue.github.io/archives title=归档>
<span>归档</span>
</a>
</li></ul></nav></header><main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://tianyuxue.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://tianyuxue.github.io/posts/>Posts</a></div><h1 class=post-title>
Kratos 源码分析 - MySQL部分
</h1><div class=post-meta><span title="2021-01-07 00:00:00 +0000 UTC">January 7, 2021</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;jitianyu
</div></header><figure class=entry-cover><img loading=lazy src=https://tianyuxue.github.io/images/mountain.jpg alt>
</figure><div class=post-content><blockquote>
<p>本文的讨论基于Kratos v1.0.x版本</p></blockquote><p>Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与MySQL相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述（这篇文章没有复杂的原理，只有从工程角度的一些最佳实践)。</p><h2 id=1-核心对象的封装>1 核心对象的封装<a hidden class=anchor aria-hidden=true href=#1-核心对象的封装>#</a></h2><p>Kratos的数据层代码主要是对Golang SDK的二次封装。在GolangSDK中，database/sql包提供了对SQL的支持，具体而言，这个包提供了如下的抽象：</p><ul>
<li><code>DB</code> 抽象表示数据库本身，也可以将其理解为数据库连接池</li><li><code>Conn</code> 抽象表示单独一个数据库连接</li><li><code>Tx</code> 抽象表示一次数据库事务操作</li><li><code>Stmt</code> 抽象表示一个Prepared Statement</li><li><code>Row/Rows</code> 抽象表示一次数据库交互后的结果</li></ul><p><code>database/sql</code>包提供的这些抽象接口是直观的，易用的，足够应付简单的应用场景。Kratos对上面这几个对象再次进行了封装，提供了实际开发中经常用到的如下功能：</p><ul>
<li>MySQL读写分离</li><li>链路追踪</li><li>统计信息</li><li>慢查询日志记录</li><li>融断保护</li></ul><p>下面我从代码的角度分析下Kratos是如何实现上述功能的。</p><h2 id=2-功能点的实现>2 功能点的实现<a hidden class=anchor aria-hidden=true href=#2-功能点的实现>#</a></h2><h3 id=21-mysql读写分离>2.1 MySQL读写分离<a hidden class=anchor aria-hidden=true href=#21-mysql读写分离>#</a></h3><p>Kratos从DAO层的代码层面实现了对MySQL读写分离的支持，并未使用数据库中间件。首先看下Kratos需要用户提供的MySQL集群配置信息：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>pkg</span><span style=color:#f92672>/</span><span style=color:#a6e22e>database</span><span style=color:#f92672>/</span><span style=color:#a6e22e>sql</span><span style=color:#f92672>/</span><span style=color:#a6e22e>mysql</span>.<span style=color:#66d9ef>go</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Config</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DSN</span>          <span style=color:#66d9ef>string</span>          <span style=color:#75715e>// write data source name.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ReadDSN</span>      []<span style=color:#66d9ef>string</span>        <span style=color:#75715e>// read data source name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Active</span>       <span style=color:#66d9ef>int</span>             <span style=color:#75715e>// pool
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Idle</span>         <span style=color:#66d9ef>int</span>             <span style=color:#75715e>// pool
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>IdleTimeout</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>   <span style=color:#75715e>// connect max life time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>QueryTimeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>   <span style=color:#75715e>// query sql timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ExecTimeout</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>   <span style=color:#75715e>// execute sql timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>TranTimeout</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>   <span style=color:#75715e>// transaction sql timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Breaker</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>Config</span> <span style=color:#75715e>// breaker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看出，<code>DSN</code>和<code>ReadDSN</code>分别存储了MySQL主节点地址和从节点地址，从节点地址有多个。Kratos会根据上述配置，生成如下的连接池对象：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DB</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span><span style=color:#a6e22e>write</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span>   <span style=color:#75715e>//主节点连接池，conn定义见下文
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>read</span>   []<span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span> <span style=color:#75715e>//从节点连接池
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>idx</span>    <span style=color:#66d9ef>int64</span>   <span style=color:#75715e>// 用于选取从节点的id
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>master</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>      <span style=color:#75715e>//MySQL的主节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></td></tr></table></div></div><p>DB对象使用<code>master</code>字段冗余存储主节点的信息，用来支持一些特定业务场景下，必须查询主库的操作。<code>write/read</code>字段分别表示数据库具体连接池，从<code>conn</code>类型的定义可以看到，其内部封装了Golang SDK中的 <code>sql.DB</code>对象：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// conn database connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>conn</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>  <span style=color:#75715e>// 对Golang SDK连接池的封装，用来支持MySQL读写分离
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>breaker</span> <span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>Breaker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conf</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>Config</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addr</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这样通过把Golang SDK中的<code>sql.DB</code>嵌入到<code>conn</code>对象中，再把多个<code>conn</code>对象封装到<code>DB</code>对象中，就使Kratos的<code>DB</code>对象支持了对MySQL集群的多个实例的读写。下面是Kratos中查询从库的方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Query executes a query that returns rows, typically a SELECT. The args are
</span></span></span><span style=display:flex><span><span style=color:#75715e>// for any placeholder parameters in the query.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>Query</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) (<span style=color:#a6e22e>rows</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Rows</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取要读取哪一个从库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>readIndex</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>read</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 依次尝试每一个从库, 只要一个成功了就返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rows</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>read</span>[(<span style=color:#a6e22e>idx</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span>)<span style=color:#f92672>%</span>len(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>read</span>)].<span style=color:#a6e22e>query</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>); !<span style=color:#a6e22e>ecode</span>.<span style=color:#a6e22e>EqualError</span>(<span style=color:#a6e22e>ecode</span>.<span style=color:#a6e22e>ServiceUnavailable</span>, <span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从库失败了的话就查询主库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>write</span>.<span style=color:#a6e22e>query</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 简单的使用轮询策略选择要读取的从库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>readIndex</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>read</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>idx</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>v</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>read</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>从<code>readIndex()</code>方法中可以看到，Kratos在查询从库时候使用了简单轮寻的方法，每次查询前使用cas方式将内部变量idx自增，然后通过取mod的方式确定要查询哪一个从库。<code>Query()</code>方法中循环尝试读取每一个从库，<strong>只有读取成功了一次后才返回</strong>，这样避免了个别从库故障导致的读取失败。</p><p>除了读操作之外，对于写入的操作，Kratos同样对Golang SDK中sql.DB的如下方法进行了封装：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 启动MySQL事务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>Begin</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>tx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>write</span>.<span style=color:#a6e22e>begin</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 执行无返回结果的SQL语句
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>Exec</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) (<span style=color:#a6e22e>res</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Result</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>write</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 创建Prepared Statement，如果出错会返回错误信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>Prepare</span>(<span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Stmt</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>write</span>.<span style=color:#a6e22e>prepare</span>(<span style=color:#a6e22e>query</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 创建Prepared Statement，如果出错会后台重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DB</span>) <span style=color:#a6e22e>Prepared</span>(<span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>stmt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Stmt</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>write</span>.<span style=color:#a6e22e>prepared</span>(<span style=color:#a6e22e>query</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>通过上述几个方法的封装，Kratos直接使用主库的数据库连接池进行插入删除等操作。这样Kratos在DAO的代码层面实现对Golang原生<code>database/sql</code>包的封装。</p><p>再看一下prepare statement的创建, Kratos的提供了<code>Prepared()</code>方法，如果创建prepare statement错误，那么启动一个goroutine不断重试，直到创建成功了，就用cas方法把prepare statement存储在Kratos封装的<code>Stmt</code>对象中， 个人感觉这样不够优雅，不知道b站内部是怎么用这个方法的：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Stmt prepared stmt.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Stmt</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>tx</span>    <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stmt</span>  <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span>  <span style=color:#75715e>// 存储创建好的prepare statement
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span>     <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Trace</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span>) <span style=color:#a6e22e>prepare</span>(<span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Stmt</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>slowLog</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Prepare query(%s)&#34;</span>, <span style=color:#a6e22e>query</span>), <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stmt</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Prepare</span>(<span style=color:#a6e22e>query</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Wrapf</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;prepare %s&#34;</span>, <span style=color:#a6e22e>query</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>st</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Stmt</span>{<span style=color:#a6e22e>query</span>: <span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>db</span>: <span style=color:#a6e22e>db</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>st</span>.<span style=color:#a6e22e>stmt</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>stmt</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>st</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span>) <span style=color:#a6e22e>prepared</span>(<span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>stmt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Stmt</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>slowLog</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;Prepared query(%s)&#34;</span>, <span style=color:#a6e22e>query</span>), <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stmt</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Stmt</span>{<span style=color:#a6e22e>query</span>: <span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>db</span>: <span style=color:#a6e22e>db</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Prepare</span>(<span style=color:#a6e22e>query</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>stmt</span>.<span style=color:#a6e22e>stmt</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果执行创建prepare出错了，这里后台执行不断重试，直到成功为止
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Prepare</span>(<span style=color:#a6e22e>query</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>stmt</span>.<span style=color:#a6e22e>stmt</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>除了MySQL读写分离，Kratos对其他方法的封装主要是为了提供慢查询日志，trace日志，监控信息和熔断保护这四个功能。</p><h3 id=22-慢查询日志>2.2 慢查询日志<a hidden class=anchor aria-hidden=true href=#22-慢查询日志>#</a></h3><p>Kratos在每个与数据库交互方法中记录了慢查询日志，结合关键字<code>defer</code>，其实现方法非常简单：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span>) <span style=color:#a6e22e>Query</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>tx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Tx</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取当前时间，通过defer来确定结束时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>slowLog</span>(<span style=color:#e6db74>&#34;Begin&#34;</span>, <span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 时间超过阈值，就打印一条警告记录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>slowLog</span>(<span style=color:#a6e22e>statement</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>du</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>du</span> &gt; <span style=color:#a6e22e>_slowLogDuration</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Warn</span>(<span style=color:#e6db74>&#34;%s slow log statement: %s time: %v&#34;</span>, <span style=color:#a6e22e>_family</span>, <span style=color:#a6e22e>statement</span>, <span style=color:#a6e22e>du</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>与数据库交互的每个方法中，Kratos都加入了上述代码片段记录慢查询的警告日志。</p><h3 id=23-监控信息>2.3 监控信息<a hidden class=anchor aria-hidden=true href=#23-监控信息>#</a></h3><p>在数据库链接层面，Kratos封装了prometheus客户端代码，提供了4个主要的监控信息：</p><ul>
<li>请求处理时长</li><li>错误请求数</li><li>数据库连接总数</li><li>当前数据库连接数</li></ul><p>具体的代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>pkg</span><span style=color:#f92672>/</span><span style=color:#a6e22e>database</span><span style=color:#f92672>/</span><span style=color:#a6e22e>sql</span><span style=color:#f92672>/</span><span style=color:#a6e22e>metrics</span>.<span style=color:#66d9ef>go</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>sql</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/go-kratos/kratos/pkg/stat/metric&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>namespace</span> = <span style=color:#e6db74>&#34;mysql_client&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_metricReqDur</span> = <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>NewHistogramVec</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>HistogramVecOpts</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Namespace</span>: <span style=color:#a6e22e>namespace</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Subsystem</span>: <span style=color:#e6db74>&#34;requests&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;duration_ms&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Help</span>:      <span style=color:#e6db74>&#34;mysql client requests duration(ms).&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Labels</span>:    []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;command&#34;</span>},
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Buckets</span>:   []<span style=color:#66d9ef>float64</span>{<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>250</span>, <span style=color:#ae81ff>500</span>, <span style=color:#ae81ff>1000</span>, <span style=color:#ae81ff>2500</span>},
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_metricReqErr</span> = <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>NewCounterVec</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>CounterVecOpts</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Namespace</span>: <span style=color:#a6e22e>namespace</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Subsystem</span>: <span style=color:#e6db74>&#34;requests&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;error_total&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Help</span>:      <span style=color:#e6db74>&#34;mysql client requests error count.&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Labels</span>:    []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;command&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>},
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_metricConnTotal</span> = <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>NewCounterVec</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>CounterVecOpts</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Namespace</span>: <span style=color:#a6e22e>namespace</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Subsystem</span>: <span style=color:#e6db74>&#34;connections&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;total&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Help</span>:      <span style=color:#e6db74>&#34;mysql client connections total count.&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Labels</span>:    []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;state&#34;</span>},
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_metricConnCurrent</span> = <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>NewGaugeVec</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>GaugeVecOpts</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Namespace</span>: <span style=color:#a6e22e>namespace</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Subsystem</span>: <span style=color:#e6db74>&#34;connections&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;current&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Help</span>:      <span style=color:#e6db74>&#34;mysql client connections current.&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Labels</span>:    []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;addr&#34;</span>, <span style=color:#e6db74>&#34;state&#34;</span>},
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>Kratos已经把上面监控数据嵌入在封装好的数据库交互的方法中，例如数据库读写发生错误后会调用<code>_metricReqErr.Inc()</code>, 读写完成后会调用<code>_metricReqDur.Observe()</code>。</p><h3 id=24-断路器>2.4 断路器<a hidden class=anchor aria-hidden=true href=#24-断路器>#</a></h3><p>Kratos的DB对象内置了断路器，存储在DB对象的breaker字段中，断路器的接口很简单，主要提供了如下三个方法：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Breaker 定义了断路器接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Breaker</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Allow</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MarkSuccess</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MarkFailed</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//在连接发出请求前判断熔断器状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>Allow</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//连接执行成功或失败将结果告知breaker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>respErr</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>){
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>MarkFailed</span>()
</span></span><span style=display:flex><span>}<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>     <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>MarkSuccess</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Kratos在与数据库交互前会检查断路器状态</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>执行完SQL语句后更新断路器状态</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>例如在exec</span>()<span style=color:#a6e22e>方法中</span><span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>conn</span>) <span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>query</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) (<span style=color:#a6e22e>res</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Result</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行方法前确认断路器状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>Allow</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_metricReqErr</span>.<span style=color:#a6e22e>Inc</span>(<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>addr</span>, <span style=color:#e6db74>&#34;exec&#34;</span>, <span style=color:#e6db74>&#34;breaker&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>conf</span>.<span style=color:#a6e22e>ExecTimeout</span>.<span style=color:#a6e22e>Shrink</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>ExecContext</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>args</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 方法执行完毕后更新断路器状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>onBreaker</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_metricReqDur</span>.<span style=color:#a6e22e>Observe</span>(int64(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>now</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>), <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>addr</span>, <span style=color:#e6db74>&#34;exec&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Wrapf</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;exec:%s, args:%+v&#34;</span>, <span style=color:#a6e22e>query</span>, <span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=25-trace信息>2.5 trace信息<a hidden class=anchor aria-hidden=true href=#25-trace信息>#</a></h3><p>Kratos通过context来传递trace信息，见如下代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>FromContext</span>(<span style=color:#a6e22e>c</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span> = <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Fork</span>(<span style=color:#a6e22e>_family</span>, <span style=color:#e6db74>&#34;exec&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetTag</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>TagAddress</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>addr</span>), <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>TagComment</span>, <span style=color:#a6e22e>query</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Finish</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>amp</span>;<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在从context获取了trace的记录单元后，同样使用了defer关键字记录了日志的终止信息。上述代码片段在每一个数据库交互方法中都存在，这样就实现了在读写数据库层面的trace信息记录。</p><h2 id=3-总结>3 总结<a hidden class=anchor aria-hidden=true href=#3-总结>#</a></h2><p>本文从源码层面讨论了Kratos框架对读写MySQL提供的一些工程上的最佳实践。</p></div><footer class=post-footer>
<ul class=post-tags>
<li><a href=https://tianyuxue.github.io/tags/kratos/>kratos</a></li><li><a href=https://tianyuxue.github.io/tags/mysql/>mysql</a></li></ul><nav class=paginav>
<a class=prev href=https://tianyuxue.github.io/posts/kratos-src-cache/>
<span class=title>« Prev Page</span>
<br>
<span>Kratos源码分析 - 缓存部分</span>
</a>
<a class=next href=https://tianyuxue.github.io/posts/golang-gc/>
<span class=title>Next Page »</span>
<br>
<span>关于Golang GC的一些分析</span>
</a>
</nav></footer></article></main><footer class=footer>
<span>&copy; 2022 <a href=https://tianyuxue.github.io/>ACoder</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
<div>
<a href=https://beian.miit.gov.cn/ rel="external nofollow" target=_blank>京ICP备2021000699号</a>
</div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script>
</body></html>
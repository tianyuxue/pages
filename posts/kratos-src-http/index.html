<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Kratos源码分析 - http部分 | ACoder</title>
<meta name=keywords content="http,kratos">
<meta name=description content="
本文的讨论基于Kratos v1.0.x版本

Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与缓存相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述。">
<meta name=author content="jitianyu">
<link rel=canonical href=https://tianyuxue.github.io/posts/kratos-src-http/>
<meta name=google-site-verification content="G-0T00DX73T1">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=preload href=images/code.png as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://tianyuxue.github.io/images/code.png>
<link rel=icon type=image/png sizes=16x16 href=https://tianyuxue.github.io/images/code.png>
<link rel=icon type=image/png sizes=32x32 href=https://tianyuxue.github.io/images/code.png>
<link rel=apple-touch-icon href=https://tianyuxue.github.io/images/code.png>
<link rel=mask-icon href=https://tianyuxue.github.io/images/code.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0T00DX73T1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-0T00DX73T1',{anonymize_ip:!1})}</script>
<meta property="og:title" content="Kratos源码分析 - http部分">
<meta property="og:description" content="
本文的讨论基于Kratos v1.0.x版本

Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与缓存相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://tianyuxue.github.io/posts/kratos-src-http/">
<meta property="og:image" content="https://tianyuxue.github.io/images/mountain.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-01-19T00:00:00+00:00">
<meta property="article:modified_time" content="2021-01-19T00:00:00+00:00"><meta property="og:site_name" content="ACoder">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://tianyuxue.github.io/images/mountain.jpg">
<meta name=twitter:title content="Kratos源码分析 - http部分">
<meta name=twitter:description content="
本文的讨论基于Kratos v1.0.x版本

Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与缓存相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述。">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://tianyuxue.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Kratos源码分析 - http部分","item":"https://tianyuxue.github.io/posts/kratos-src-http/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kratos源码分析 - http部分","name":"Kratos源码分析 - http部分","description":" 本文的讨论基于Kratos v1.0.x版本\n Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与缓存相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述。\n","keywords":["http","kratos"],"articleBody":" 本文的讨论基于Kratos v1.0.x版本\n Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与缓存相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述。\n1 核心对象的分析 Kratos http模块叫做blademaster，其主要设计参考了借鉴Gin的代码。整个http 模块可以拆分如下3个部分：\n图 1 blademaster模块架构\n Router对象借鉴了Gin的设计，使用Radix Tree存储了全部的路由信息 Context封装了一个http请求相关的所有上下文信息，Context的存在统一了Handler的接口 Handlers对象是职责链模式的实现，用于处理http请求。对于每一个请求，有一串handler依次处理，一个handler处理成功后可以交给下一个，也可以根据情况直接将http响应返回给客户端。这三个组件的交互见下图：  图 2 blademaster组件交互图\nKratos使用struct Engine封装了上面3个对象，Engine对象的定义如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  type Engine struct { RouterGroup // 用于注册路由信息  lock sync.RWMutex conf *ServerConfig // 配置信息  address string // 服务地址  trees methodTrees // 基数树存储路由信息 \tserver atomic.Value // store *http.Server \tmetastore map[string]map[string]interface{} // metastore is the path as key and the metadata of this path as value, it export via /metadata  pcLock sync.RWMutex methodConfigs map[string]*MethodConfig injections []injection // If enabled, the url.RawPath will be used to find parameters. \tUseRawPath bool // If true, the path value will be unescaped. \t// If UseRawPath is false (by default), the UnescapePathValues effectively is true, \t// as url.Path gonna be used, which is already unescaped. \tUnescapePathValues bool // If enabled, the router checks if another method is allowed for the \t// current route, if the current request can not be routed. \t// If this is the case, the request is answered with 'Method Not Allowed' \t// and HTTP status code 405. \t// If no other Method is allowed, the request is delegated to the NotFound \t// handler. \tHandleMethodNotAllowed bool allNoRoute []HandlerFunc allNoMethod []HandlerFunc noRoute []HandlerFunc noMethod []HandlerFunc pool sync.Pool // Context池，复用Context对象，减少GC压力 }   每一个Context对象中保存了它所需要的Handler，Context对象的定义如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  type Context struct { context.Context // 提供golang标准context的接口  Request *http.Request // http请求的内存对象 \tWriter http.ResponseWriter // http响应的内存对象  // flow control \tindex int8 //当前执行到了第几个handler \thandlers []HandlerFunc //所有需要执行的handler  // Keys is a key/value pair exclusively for the context of each request. \tKeys map[string]interface{} // This mutex protect Keys map \tkeysMutex sync.RWMutex Error error method string engine *Engine RoutePath string Params Params }   这样通过这Context + Handler，通过职责链模式提供了很高的代码扩展性，尤其契合Http请求处理这种场景。下面具体探讨下Http服务器需要重点关注的一些内容：\n IO模型 路由信息的处理  1.1 IO模型 blademaster直接使用了golang官方的http.Server包。在Engine对象的启动代码Run()方法可以看到：\n1 2 3 4 5 6 7 8 9 10 11 12  func (engine *Engine) Run(addr ...string) (err error) { address := resolveAddress(addr) server := \u0026http.Server{ Addr: address, Handler: engine, } engine.server.Store(server) if err = server.ListenAndServe(); err != nil { err = errors.Wrapf(err, \"addrs: %v\", addr) } return }   代码中启动了http.Server，在Engine.ServeHttp()方法（代码如下）中可以看到，Engine接管了所有的http请求，每当请求到来时候，就从Context Pool中获取一个Context对象，处理完毕后归还到Context Pool中。\n1 2 3 4 5 6 7 8 9 10  // ServeHTTP conforms to the http.Handler interface. func (engine *Engine) ServeHTTP(w http.ResponseWriter, req *http.Request) { c := engine.pool.Get().(*Context) c.Request = req c.Writer = w c.reset() engine.handleContext(c) engine.pool.Put(c) }   这样就能看出blademaster并未实现自己的线程模型，完全使用了官方http包中一个连接一个goroutine的线程模型，所有处理连接的goroutine会调用阻塞式的读写方法，一旦数据未准备好，就会进入阻塞状态，数据到达后由netpoller唤醒阻塞的goroutine进行处理，因此，Kratos 的http线程模型可以视为单Reactor多线程模式。\n1.2 路由信息的存储 在Http服务器处理业务请求的时候，查询最多的就是路由信息了，一个大型应用可能会注册很多路由信息，在高并发下被大量查询，因此其查询效率非常重要。众所周知，哈希表的O(1)查询效率当然是最快的，将所有路由信息存储到hash表里能解决问题么？如果路由信息都是常量，这样是最简单的方式。但是路由信息中还存在很多参数，尤其在restful风格的接口设计中，因此blademaster或者说是Gin采用了基数树这个数据结构来存储。\n在blademaster的代码中，每一个Http方法，比如GET、POST方法，其路由信息存储在一个基数树中，所有Http方法的路由信息构成了一个森林，存储在Engine结构体的methodTrees对象中。树中每一个节点的定义如下：\n1 2 3 4 5 6 7 8 9 10  type node struct { path string // 存储的路径 \tindices string children []*node // 孩子节点 \thandlers []HandlerFunc // 该路径的处理函数 \tpriority uint32 nType nodeType // 节点类型 \tmaxParams uint8 wildChild bool // 是否是含有url参数的节点 }   通过基数树这种数据结构，解决了带参数URL的查询效率问题。具体的基数树的代码过于细节，本文主要讨论blademaster的实现，这里就不再深入，后续我计划专门写一篇文章来理解基数树在Gin中的使用。\n2 部分常用业务功能的实现 2.1 CORS CORS用来支持浏览器跨域请求，Kratos的http模块提供了支持CORS的方法，其核心功能很简单：\n 预先配置允许跨域访问的地址 当CORS请求到达之后，验证与配置的地址是否匹配 验证成功后返回特定的Http Header给客户端，否则返回错误信息  Kratos通过传入地址数组创建出CORS middleware，创建代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  // CORS returns the location middleware with default configuration. // 传入允许访问的跨域地址 func CORS(allowOriginHosts []string) HandlerFunc { config := \u0026CORSConfig{ AllowMethods: []string{\"GET\", \"POST\"}, AllowHeaders: []string{\"Origin\", \"Content-Length\", \"Content-Type\"}, AllowCredentials: true, MaxAge: time.Duration(0), AllowOriginFunc: func(origin string) bool { for _, host := range allowOriginHosts { if strings.HasSuffix(strings.ToLower(origin), host) { return true } } return false }, } return newCORS(config) } // newCORS returns the location middleware with user-defined custom configuration. // 返回cors middleware func newCORS(config *CORSConfig) HandlerFunc { if err := config.Validate(); err != nil { panic(err.Error()) } cors := \u0026cors{ allowOriginFunc: config.AllowOriginFunc, allowAllOrigins: config.AllowAllOrigins, allowCredentials: config.AllowCredentials, allowOrigins: normalize(config.AllowOrigins), normalHeaders: generateNormalHeaders(config), preflightHeaders: generatePreflightHeaders(config), } return func(c *Context) { cors.applyCORS(c) } }   cors.applyCORS() 方法中实现CORS的验证逻辑，代码如下，具体细节可以参考注释。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  func (cors *cors) applyCORS(c *Context) { origin := c.Request.Header.Get(\"Origin\") // 通过http header中的orgin判断是否是跨域请求 \tif len(origin) == 0 { // request is not a CORS request \treturn } // 通过当前请求域名与允许的域名匹配 \tif !cors.validateOrigin(origin) { log.V(5).Info(\"The request's Origin header `%s` does not match any of allowed origins.\", origin) // 如果不匹配，就返回403状态码 \tc.AbortWithStatus(http.StatusForbidden) return } // 对于OPTIONS请求进行特殊处理 \tif c.Request.Method == \"OPTIONS\" { cors.handlePreflight(c) defer c.AbortWithStatus(200) } else { // http响应的header中添加CORS相关的header \tcors.handleNormal(c) } if !cors.allowAllOrigins { header := c.Writer.Header() header.Set(\"Access-Control-Allow-Origin\", origin) } }   2.2 CSRF CSRF指的是跨站请求伪造攻击，通常造成影响较为严重。对CSRF的防护手段主要是，当表单展示的时候，在表单中增加验证的token，当表单提交后也带这这个token来确保这个表单提交不是伪造的。\nKratos对CSRF的防护做的很基础，只是检查了Http Header中的Referer字段是否合法，代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  // CSRF returns the csrf middleware to prevent invalid cross site request. // Only referer is checked currently. func CSRF(allowHosts []string, allowPattern []string) HandlerFunc { validations := []func(*url.URL) bool{} addHostSuffix := func(suffix string) { validations = append(validations, matchHostSuffix(suffix)) } addPattern := func(pattern string) { validations = append(validations, matchPattern(regexp.MustCompile(pattern))) } for _, r := range allowHosts { addHostSuffix(r) } for _, p := range allowPattern { addPattern(p) } return func(c *Context) { // 获取Header中的Refer字段 \treferer := c.Request.Header.Get(\"Referer\") if referer == \"\" { log.V(5).Info(\"The request's Referer or Origin header is empty.\") c.AbortWithStatus(403) return } illegal := true // 校验是否符合预定义的地址 \tif uri, err := url.Parse(referer); err == nil \u0026\u0026 uri.Host != \"\" { for _, validate := range validations { if validate(uri) { illegal = false break } } } if illegal { log.V(5).Info(\"The request's Referer header `%s` does not match any of allowed referers.\", referer) // 不符合返回403 \tc.AbortWithStatus(403) return } } }   对于需要严格防护CSRF攻击的场景，还需要使用其他第三方的库，或者自己实现解决方案。\n2.3 限流 kratos 借鉴了 Sentinel 项目的自适应限流系统，通过综合分析服务的 cpu 使用率、请求成功的 qps 和请求成功的 rt 来做自适应限流保护。这篇文章只讨论http模块，具体的限流算法我会另外选择文章来讨论。Kratos也将限流功能以中间件方式实现：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // Limit return a bm handler func. func (b *RateLimiter) Limit() HandlerFunc { return func(c *Context) { uri := fmt.Sprintf(\"%s://%s%s\", c.Request.URL.Scheme, c.Request.Host, c.Request.URL.Path) limiter := b.group.Get(uri) // 执行限流 \tdone, err := limiter.Allow(c) if err != nil { // 流量被限制后返回错误 \t_metricServerBBR.Inc(uri, c.Request.Method) c.JSON(nil, err) c.Abort() return } // 成功处理后更新统计信息，作为后续限流依据 \tdefer func() { done(limit.DoneInfo{Op: limit.Success}) b.printStats(uri, limiter) }() c.Next() } }   可以看出，中间件的抽象有助于代码的扩展，可以根据项目情况灵活的选用不同的限流方式。\n2.4 日志 blademaster中的日志功能与其他框架类似，提供了http请求相关信息的记录，Log中间件的具体代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63  // Logger is logger middleware func Logger() HandlerFunc { const noUser = \"no_user\" return func(c *Context) { // 获取执行剩余handler前的信息 \tnow := time.Now() req := c.Request path := req.URL.Path params := req.Form var quota float64 if deadline, ok := c.Context.Deadline(); ok { quota = time.Until(deadline).Seconds() } // 执行剩余handler \tc.Next() // 获取handler执行完毕后的信息 \terr := c.Error cerr := ecode.Cause(err) // 请求处理的时间 \tdt := time.Since(now) caller := metadata.String(c, metadata.Caller) if caller == \"\" { caller = noUser } if len(c.RoutePath)  0 { _metricServerReqCodeTotal.Inc(c.RoutePath[1:], caller, req.Method, strconv.FormatInt(int64(cerr.Code()), 10)) _metricServerReqDur.Observe(int64(dt/time.Millisecond), c.RoutePath[1:], caller, req.Method) } lf := log.Infov errmsg := \"\" isSlow := dt = (time.Millisecond * 500) // 通过是否有错误和处理时间是否过长来决定是不是使用warn级别的日志输出 \tif err != nil { errmsg = err.Error() lf = log.Errorv if cerr.Code()  0 { lf = log.Warnv } } else { if isSlow { lf = log.Warnv } } // 记录日志 \tlf(c, log.KVString(\"method\", req.Method), log.KVString(\"ip\", c.RemoteIP()), log.KVString(\"user\", caller), log.KVString(\"path\", path), log.KVString(\"params\", params.Encode()), log.KVInt(\"ret\", cerr.Code()), log.KVString(\"msg\", cerr.Message()), log.KVString(\"stack\", fmt.Sprintf(\"%+v\", err)), log.KVString(\"err\", errmsg), log.KVFloat64(\"timeout_quota\", quota), log.KVFloat64(\"ts\", dt.Seconds()), log.KVString(\"source\", \"http-access-log\"), ) } }   这个方法在handler开始处理前后记录时间，用户等想关元信息，根据处理结果是否出错以及处理时间是否过长来决定日志的输出级别。\n2.5 Trace blademaster中Trace信息的记录方式同日志信息一样，其实现代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  // Trace is trace middleware func Trace() HandlerFunc { return func(c *Context) { // 从http request header 中获取trace信息 \tt, err := trace.Extract(trace.HTTPFormat, c.Request.Header) if err != nil { var opts []trace.Option if ok, _ := strconv.ParseBool(trace.KratosTraceDebug); ok { opts = append(opts, trace.EnableDebug()) } // 如果trace 信息不存在，就根据当前url创建一个trace单元 \tt = trace.New(c.Request.URL.Path, opts...) } // 设定trace信息 包含标题和tag \tt.SetTitle(c.Request.URL.Path) t.SetTag(trace.String(trace.TagComponent, _defaultComponentName)) t.SetTag(trace.String(trace.TagHTTPMethod, c.Request.Method)) t.SetTag(trace.String(trace.TagHTTPURL, c.Request.URL.String())) t.SetTag(trace.String(trace.TagSpanKind, \"server\")) // business tag \tt.SetTag(trace.String(\"caller\", metadata.String(c.Context, metadata.Caller))) // 把trace信息加入到http header中，让用户可以查看，便于debug，同时也让下游代码可以继续记录trace信息 \tc.Writer.Header().Set(trace.KratosTraceID, t.TraceID()) // 根据trace信息，新建一个官方包里的context \tc.Context = trace.NewContext(c.Context, t) // 调用剩余的handler \tc.Next() // 标记trace信息已经完成 \tt.Finish(\u0026c.Error) } }   要记录trace信息，blademaster首先尝试从当前http request header中获取已经存在trace信息，如果trace信息不存在，说明这是链路调用的开始，就依据当前请求信息新建一个Trace单元。同样的，在handler执行前后，记录相关信息到trace单元中，然后将trace信息存放在http response header中，方便下游系统处理。trace信息中比较关键的要素有：\n trace id url地址 业务模块相关的信息 处理结果信息  2.6 Recovery 上面已经讨论过，blademaster使用的一个请求一个goroutine的IO模型，如果goroutine出现panic怎么办？这时候u需要把错误信息传递给调用方，但是panic会导致整个进程挂掉，这显然是不合理的，blademaster的recovery中间件就是用来将panic信息转化为http 500的错误信息，即保证进程运行，也把错误信息返回给客户端，类似于Spring中的Global Exception Handler。其实现代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  // Recovery returns a middleware that recovers from any panics and writes a 500 if there was one. func Recovery() HandlerFunc { return func(c *Context) { // 通过defer方法从panic中恢复 \tdefer func() { var rawReq []byte if err := recover(); err != nil { const size = 64  10 buf := make([]byte, size) // 获取出错的栈帧信息 \tbuf = buf[:runtime.Stack(buf, false)] // 获取出错的http请求的详细信息 \tif c.Request != nil { rawReq, _ = httputil.DumpRequest(c.Request, false) } pl := fmt.Sprintf(\"http call panic: %sn%vn%sn\", string(rawReq), err, buf) fmt.Fprintf(os.Stderr, pl) // 记录错误日志 \tlog.Error(pl) // 返回500错误信息 \tc.AbortWithStatus(500) } }() c.Next() } }   从上述代码中可以看到，Recovery中间件recovery()函数从panic中恢复，并返回给客户端错误信息，这也意味着Recovery中间件应该放在所有中间件的最前面。\n3 总结 本文讨论kratos blademaster模块的一些实现细节，可以看出，得益与职责链模式的使用，中间件的扩展非常灵活。\n","wordCount":"1519","inLanguage":"en","image":"https://tianyuxue.github.io/images/mountain.jpg","datePublished":"2021-01-19T00:00:00Z","dateModified":"2021-01-19T00:00:00Z","author":{"@type":"Person","name":"jitianyu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tianyuxue.github.io/posts/kratos-src-http/"},"publisher":{"@type":"Organization","name":"ACoder","logo":{"@type":"ImageObject","url":"https://tianyuxue.github.io/images/code.png"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://tianyuxue.github.io/ accesskey=h title="ACoder (Alt + H)">
<img src=https://tianyuxue.github.io/images/code.png alt=logo aria-label=logo height=35>ACoder</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://tianyuxue.github.io/search/ title="搜索 (Alt + /)" accesskey=/>
<span>搜索</span>
</a>
</li>
<li>
<a href=https://tianyuxue.github.io/posts/ title=文章>
<span>文章</span>
</a>
</li>
<li>
<a href=https://tianyuxue.github.io/categories/ title=分类>
<span>分类</span>
</a>
</li>
<li>
<a href=https://tianyuxue.github.io/tags/ title=标签>
<span>标签</span>
</a>
</li>
<li>
<a href=https://tianyuxue.github.io/about/ title=关于我>
<span><i class="fa fa-heart"></i>关于我</span>
</a>
</li>
<li>
<a href=https://tianyuxue.github.io/archives title=归档>
<span>归档</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://tianyuxue.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://tianyuxue.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Kratos源码分析 - http部分
</h1>
<div class=post-meta><span title="2021-01-19 00:00:00 +0000 UTC">January 19, 2021</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;jitianyu
</div>
</header>
<figure class=entry-cover><img loading=lazy src=https://tianyuxue.github.io/images/mountain.jpg alt>
</figure>
<div class=post-content><blockquote>
<p>本文的讨论基于Kratos v1.0.x版本</p>
</blockquote>
<p>Kratos是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具，本文主要从源码角度分析一下Kratos中与缓存相关的代码，在分析的过程中，我会从Kratos提供的不同的功能点来结合自己的一些理解进行阐述。</p>
<h2 id=1-核心对象的分析>1 核心对象的分析<a hidden class=anchor aria-hidden=true href=#1-核心对象的分析>#</a></h2>
<p>Kratos http模块叫做blademaster，其主要设计参考了借鉴Gin的代码。整个http 模块可以拆分如下3个部分：</p>
<p><img loading=lazy src=images/bm-arch-2-2.png alt>
</p>
<p>图 1 blademaster模块架构</p>
<ul>
<li>Router对象借鉴了Gin的设计，使用<strong>Radix Tree</strong>存储了全部的路由信息</li>
<li>Context封装了一个http请求相关的所有上下文信息，Context的存在统一了Handler的接口</li>
<li>Handlers对象是<strong>职责链模式</strong>的实现，用于处理http请求。对于每一个请求，有一串handler依次处理，一个handler处理成功后可以交给下一个，也可以根据情况直接将http响应返回给客户端。这三个组件的交互见下图：</li>
</ul>
<p><img loading=lazy src=images/bm-arch-2-3.png alt>
</p>
<p>图 2 blademaster组件交互图</p>
<p>Kratos使用<code>struct Engine</code>封装了上面3个对象，Engine对象的定义如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Engine</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>RouterGroup</span>  <span style=color:#75715e>// 用于注册路由信息
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
	<span style=color:#a6e22e>conf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServerConfig</span> <span style=color:#75715e>// 配置信息
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>  <span style=color:#75715e>// 服务地址
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>trees</span>     <span style=color:#a6e22e>methodTrees</span>                       <span style=color:#75715e>// 基数树存储路由信息
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>server</span>    <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span>                      <span style=color:#75715e>// store *http.Server
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>metastore</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{} <span style=color:#75715e>// metastore is the path as key and the metadata of this path as value, it export via /metadata
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>pcLock</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
	<span style=color:#a6e22e>methodConfigs</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>MethodConfig</span>

	<span style=color:#a6e22e>injections</span> []<span style=color:#a6e22e>injection</span>

	<span style=color:#75715e>// If enabled, the url.RawPath will be used to find parameters.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>UseRawPath</span> <span style=color:#66d9ef>bool</span>

	<span style=color:#75715e>// If true, the path value will be unescaped.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// If UseRawPath is false (by default), the UnescapePathValues effectively is true,
</span><span style=color:#75715e></span>	<span style=color:#75715e>// as url.Path gonna be used, which is already unescaped.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>UnescapePathValues</span> <span style=color:#66d9ef>bool</span>

	<span style=color:#75715e>// If enabled, the router checks if another method is allowed for the
</span><span style=color:#75715e></span>	<span style=color:#75715e>// current route, if the current request can not be routed.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// If this is the case, the request is answered with &#39;Method Not Allowed&#39;
</span><span style=color:#75715e></span>	<span style=color:#75715e>// and HTTP status code 405.
</span><span style=color:#75715e></span>	<span style=color:#75715e>// If no other Method is allowed, the request is delegated to the NotFound
</span><span style=color:#75715e></span>	<span style=color:#75715e>// handler.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>HandleMethodNotAllowed</span> <span style=color:#66d9ef>bool</span>

	<span style=color:#a6e22e>allNoRoute</span>  []<span style=color:#a6e22e>HandlerFunc</span>
	<span style=color:#a6e22e>allNoMethod</span> []<span style=color:#a6e22e>HandlerFunc</span>
	<span style=color:#a6e22e>noRoute</span>     []<span style=color:#a6e22e>HandlerFunc</span>
	<span style=color:#a6e22e>noMethod</span>    []<span style=color:#a6e22e>HandlerFunc</span>

	<span style=color:#a6e22e>pool</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Pool</span> <span style=color:#75715e>// Context池，复用Context对象，减少GC压力
</span><span style=color:#75715e></span>}
</code></pre></td></tr></table>
</div>
</div><p>每一个<code>Context</code>对象中保存了它所需要的Handler，<code>Context</code>对象的定义如下:</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Context</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>  <span style=color:#75715e>// 提供golang标准context的接口
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>Request</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>  <span style=color:#75715e>// http请求的内存对象
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Writer</span>  <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span> <span style=color:#75715e>// http响应的内存对象
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// flow control
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>index</span>    <span style=color:#66d9ef>int8</span>  <span style=color:#75715e>//当前执行到了第几个handler
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>handlers</span> []<span style=color:#a6e22e>HandlerFunc</span> <span style=color:#75715e>//所有需要执行的handler
</span><span style=color:#75715e></span>
	<span style=color:#75715e>// Keys is a key/value pair exclusively for the context of each request.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>Keys</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}
	<span style=color:#75715e>// This mutex protect Keys map
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>keysMutex</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>

	<span style=color:#a6e22e>Error</span> <span style=color:#66d9ef>error</span>

	<span style=color:#a6e22e>method</span> <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>engine</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Engine</span>

	<span style=color:#a6e22e>RoutePath</span> <span style=color:#66d9ef>string</span>

	<span style=color:#a6e22e>Params</span> <span style=color:#a6e22e>Params</span>
}
</code></pre></td></tr></table>
</div>
</div><p>这样通过这Context + Handler，通过职责链模式提供了很高的代码扩展性，尤其契合Http请求处理这种场景。下面具体探讨下Http服务器需要重点关注的一些内容：</p>
<ul>
<li>IO模型</li>
<li>路由信息的处理</li>
</ul>
<h3 id=11-io模型>1.1 IO模型<a hidden class=anchor aria-hidden=true href=#11-io模型>#</a></h3>
<p>blademaster直接使用了golang官方的<code>http.Server</code>包。在Engine对象的启动代码<code>Run()</code>方法可以看到：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>engine</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Engine</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>addr</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>address</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resolveAddress</span>(<span style=color:#a6e22e>addr</span>)
	<span style=color:#a6e22e>server</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
		<span style=color:#a6e22e>Addr</span>:    <span style=color:#a6e22e>address</span>,
		<span style=color:#a6e22e>Handler</span>: <span style=color:#a6e22e>engine</span>,
	}
	<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>server</span>)
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>ListenAndServe</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Wrapf</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;addrs: %v&#34;</span>, <span style=color:#a6e22e>addr</span>)
	}
	<span style=color:#66d9ef>return</span>
}
</code></pre></td></tr></table>
</div>
</div><p>代码中启动了<code>http.Server</code>，在<code>Engine.ServeHttp()</code>方法（代码如下）中可以看到，Engine接管了所有的http请求，每当请求到来时候，就从Context Pool中获取一个Context对象，处理完毕后归还到Context Pool中。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// ServeHTTP conforms to the http.Handler interface.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>engine</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Engine</span>) <span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>Get</span>().(<span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>)
	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span> = <span style=color:#a6e22e>req</span>
	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Writer</span> = <span style=color:#a6e22e>w</span>
	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>reset</span>()

	<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>handleContext</span>(<span style=color:#a6e22e>c</span>)
	<span style=color:#a6e22e>engine</span>.<span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>c</span>)
}
</code></pre></td></tr></table>
</div>
</div><p>这样就能看出blademaster并未实现自己的线程模型，完全使用了官方<code>http</code>包中<strong>一个连接一个goroutine的线程模型</strong>，所有处理连接的goroutine会调用阻塞式的读写方法，一旦数据未准备好，就会进入阻塞状态，数据到达后由netpoller唤醒阻塞的goroutine进行处理，因此，Kratos 的http线程模型可以视为<strong>单Reactor多线程模式</strong>。</p>
<h3 id=12-路由信息的存储>1.2 路由信息的存储<a hidden class=anchor aria-hidden=true href=#12-路由信息的存储>#</a></h3>
<p>在Http服务器处理业务请求的时候，查询最多的就是路由信息了，一个大型应用可能会注册很多路由信息，在高并发下被大量查询，因此其查询效率非常重要。众所周知，哈希表的O(1)查询效率当然是最快的，将所有路由信息存储到hash表里能解决问题么？如果路由信息都是常量，这样是最简单的方式。但是路由信息中还存在很多参数，尤其在restful风格的接口设计中，因此blademaster或者说是Gin采用了<strong>基数树</strong>这个数据结构来存储。</p>
<p>在blademaster的代码中，每一个Http方法，比如GET、POST方法，其路由信息存储在一个基数树中，所有Http方法的路由信息构成了一个森林，存储在<code>Engine</code>结构体的<code>methodTrees</code>对象中。树中每一个节点的定义如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>node</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>path</span>      <span style=color:#66d9ef>string</span> <span style=color:#75715e>// 存储的路径
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>indices</span>   <span style=color:#66d9ef>string</span>
	<span style=color:#a6e22e>children</span>  []<span style=color:#f92672>*</span><span style=color:#a6e22e>node</span> <span style=color:#75715e>// 孩子节点
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>handlers</span>  []<span style=color:#a6e22e>HandlerFunc</span> <span style=color:#75715e>// 该路径的处理函数
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>priority</span>  <span style=color:#66d9ef>uint32</span>
	<span style=color:#a6e22e>nType</span>     <span style=color:#a6e22e>nodeType</span>  <span style=color:#75715e>// 节点类型
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>maxParams</span> <span style=color:#66d9ef>uint8</span>
	<span style=color:#a6e22e>wildChild</span> <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// 是否是含有url参数的节点
</span><span style=color:#75715e></span>}
</code></pre></td></tr></table>
</div>
</div><p>通过基数树这种数据结构，解决了带参数URL的查询效率问题。具体的基数树的代码过于细节，本文主要讨论blademaster的实现，这里就不再深入，后续我计划专门写一篇文章来理解基数树在Gin中的使用。</p>
<h2 id=2-部分常用业务功能的实现>2 部分常用业务功能的实现<a hidden class=anchor aria-hidden=true href=#2-部分常用业务功能的实现>#</a></h2>
<h3 id=21-cors>2.1 CORS<a hidden class=anchor aria-hidden=true href=#21-cors>#</a></h3>
<p>CORS用来支持浏览器跨域请求，Kratos的http模块提供了支持CORS的方法，其核心功能很简单：</p>
<ul>
<li>预先配置允许跨域访问的地址</li>
<li>当CORS请求到达之后，验证与配置的地址是否匹配</li>
<li>验证成功后返回特定的Http Header给客户端，否则返回错误信息</li>
</ul>
<p>Kratos通过传入<strong>地址数组</strong>创建出CORS middleware，创建代码如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// CORS returns the location middleware with default configuration.
</span><span style=color:#75715e>// 传入允许访问的跨域地址
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CORS</span>(<span style=color:#a6e22e>allowOriginHosts</span> []<span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#a6e22e>config</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CORSConfig</span>{
		<span style=color:#a6e22e>AllowMethods</span>:     []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;POST&#34;</span>},
		<span style=color:#a6e22e>AllowHeaders</span>:     []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;Origin&#34;</span>, <span style=color:#e6db74>&#34;Content-Length&#34;</span>, <span style=color:#e6db74>&#34;Content-Type&#34;</span>},
		<span style=color:#a6e22e>AllowCredentials</span>: <span style=color:#66d9ef>true</span>,
		<span style=color:#a6e22e>MaxAge</span>:           <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>0</span>),
		<span style=color:#a6e22e>AllowOriginFunc</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>origin</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>host</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allowOriginHosts</span> {
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasSuffix</span>(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>origin</span>), <span style=color:#a6e22e>host</span>) {
					<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
				}
			}
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
		},
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newCORS</span>(<span style=color:#a6e22e>config</span>)
}

<span style=color:#75715e>// newCORS returns the location middleware with user-defined custom configuration.
</span><span style=color:#75715e>// 返回cors middleware
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newCORS</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CORSConfig</span>) <span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Validate</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
	}
	<span style=color:#a6e22e>cors</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cors</span>{
		<span style=color:#a6e22e>allowOriginFunc</span>:  <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>AllowOriginFunc</span>,
		<span style=color:#a6e22e>allowAllOrigins</span>:  <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>AllowAllOrigins</span>,
		<span style=color:#a6e22e>allowCredentials</span>: <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>AllowCredentials</span>,
		<span style=color:#a6e22e>allowOrigins</span>:     <span style=color:#a6e22e>normalize</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>AllowOrigins</span>),
		<span style=color:#a6e22e>normalHeaders</span>:    <span style=color:#a6e22e>generateNormalHeaders</span>(<span style=color:#a6e22e>config</span>),
		<span style=color:#a6e22e>preflightHeaders</span>: <span style=color:#a6e22e>generatePreflightHeaders</span>(<span style=color:#a6e22e>config</span>),
	}

	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
		<span style=color:#a6e22e>cors</span>.<span style=color:#a6e22e>applyCORS</span>(<span style=color:#a6e22e>c</span>)
	}
}
</code></pre></td></tr></table>
</div>
</div><p><code>cors.applyCORS()</code> 方法中实现CORS的验证逻辑，代码如下，具体细节可以参考注释。</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cors</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cors</span>) <span style=color:#a6e22e>applyCORS</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
	<span style=color:#a6e22e>origin</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Origin&#34;</span>)
	<span style=color:#75715e>// 通过http header中的orgin判断是否是跨域请求
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>origin</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
		<span style=color:#75715e>// request is not a CORS request
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#75715e>// 通过当前请求域名与允许的域名匹配
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>cors</span>.<span style=color:#a6e22e>validateOrigin</span>(<span style=color:#a6e22e>origin</span>) {
		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;The request&#39;s Origin header `%s` does not match any of allowed origins.&#34;</span>, <span style=color:#a6e22e>origin</span>)
		<span style=color:#75715e>// 如果不匹配，就返回403状态码
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusForbidden</span>)
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// 对于OPTIONS请求进行特殊处理
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Method</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;OPTIONS&#34;</span> {
		<span style=color:#a6e22e>cors</span>.<span style=color:#a6e22e>handlePreflight</span>(<span style=color:#a6e22e>c</span>)
		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#ae81ff>200</span>)
	} <span style=color:#66d9ef>else</span> {
		<span style=color:#75715e>// http响应的header中添加CORS相关的header
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>cors</span>.<span style=color:#a6e22e>handleNormal</span>(<span style=color:#a6e22e>c</span>)
	}

	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>cors</span>.<span style=color:#a6e22e>allowAllOrigins</span> {
		<span style=color:#a6e22e>header</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Writer</span>.<span style=color:#a6e22e>Header</span>()
		<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Access-Control-Allow-Origin&#34;</span>, <span style=color:#a6e22e>origin</span>)
	}
}
</code></pre></td></tr></table>
</div>
</div><h3 id=22-csrf>2.2 CSRF<a hidden class=anchor aria-hidden=true href=#22-csrf>#</a></h3>
<p>CSRF指的是跨站请求伪造攻击，通常造成影响较为严重。对CSRF的防护手段主要是，当表单展示的时候，在表单中增加验证的token，当表单提交后也带这这个token来确保这个表单提交不是伪造的。</p>
<p>Kratos对CSRF的防护做的很基础，只是检查了Http Header中的Referer字段是否合法，代码如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// CSRF returns the csrf middleware to prevent invalid cross site request.
</span><span style=color:#75715e>// Only referer is checked currently.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>CSRF</span>(<span style=color:#a6e22e>allowHosts</span> []<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>allowPattern</span> []<span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#a6e22e>validations</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>URL</span>) <span style=color:#66d9ef>bool</span>{}

	<span style=color:#a6e22e>addHostSuffix</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>suffix</span> <span style=color:#66d9ef>string</span>) {
		<span style=color:#a6e22e>validations</span> = append(<span style=color:#a6e22e>validations</span>, <span style=color:#a6e22e>matchHostSuffix</span>(<span style=color:#a6e22e>suffix</span>))
	}
	<span style=color:#a6e22e>addPattern</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pattern</span> <span style=color:#66d9ef>string</span>) {
		<span style=color:#a6e22e>validations</span> = append(<span style=color:#a6e22e>validations</span>, <span style=color:#a6e22e>matchPattern</span>(<span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#a6e22e>pattern</span>)))
	}

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allowHosts</span> {
		<span style=color:#a6e22e>addHostSuffix</span>(<span style=color:#a6e22e>r</span>)
	}
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allowPattern</span> {
		<span style=color:#a6e22e>addPattern</span>(<span style=color:#a6e22e>p</span>)
	}

	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
		<span style=color:#75715e>// 获取Header中的Refer字段
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>referer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Referer&#34;</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>referer</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;The request&#39;s Referer or Origin header is empty.&#34;</span>)
			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#ae81ff>403</span>)
			<span style=color:#66d9ef>return</span>
		}
		<span style=color:#a6e22e>illegal</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>

		<span style=color:#75715e>// 校验是否符合预定义的地址
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>uri</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>referer</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>uri</span>.<span style=color:#a6e22e>Host</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>validate</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>validations</span> {
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>validate</span>(<span style=color:#a6e22e>uri</span>) {
					<span style=color:#a6e22e>illegal</span> = <span style=color:#66d9ef>false</span>
					<span style=color:#66d9ef>break</span>
				}
			}
		}
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>illegal</span> {
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;The request&#39;s Referer header `%s` does not match any of allowed referers.&#34;</span>, <span style=color:#a6e22e>referer</span>)
			<span style=color:#75715e>// 不符合返回403
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#ae81ff>403</span>)
			<span style=color:#66d9ef>return</span>
		}
	}
}
</code></pre></td></tr></table>
</div>
</div><p>对于需要严格防护CSRF攻击的场景，还需要使用其他第三方的库，或者自己实现解决方案。</p>
<h3 id=23-限流>2.3 限流<a hidden class=anchor aria-hidden=true href=#23-限流>#</a></h3>
<p>kratos 借鉴了 Sentinel 项目的自适应限流系统，通过综合分析服务的 cpu 使用率、请求成功的 qps 和请求成功的 rt 来做自适应限流保护。这篇文章只讨论http模块，具体的限流算法我会另外选择文章来讨论。Kratos也将限流功能以中间件方式实现：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Limit return a bm handler func.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RateLimiter</span>) <span style=color:#a6e22e>Limit</span>() <span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
		<span style=color:#a6e22e>uri</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s://%s%s&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Scheme</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Host</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>)
		<span style=color:#a6e22e>limiter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>group</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>uri</span>)
		<span style=color:#75715e>// 执行限流
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>done</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>limiter</span>.<span style=color:#a6e22e>Allow</span>(<span style=color:#a6e22e>c</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#75715e>// 流量被限制后返回错误
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>_metricServerBBR</span>.<span style=color:#a6e22e>Inc</span>(<span style=color:#a6e22e>uri</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Method</span>)
			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>)
			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Abort</span>()
			<span style=color:#66d9ef>return</span>
		}
		<span style=color:#75715e>// 成功处理后更新统计信息，作为后续限流依据
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
			<span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>DoneInfo</span>{<span style=color:#a6e22e>Op</span>: <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>Success</span>})
			<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>printStats</span>(<span style=color:#a6e22e>uri</span>, <span style=color:#a6e22e>limiter</span>)
		}()
		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><p>可以看出，中间件的抽象有助于代码的扩展，可以根据项目情况灵活的选用不同的限流方式。</p>
<h3 id=24-日志>2.4 日志<a hidden class=anchor aria-hidden=true href=#24-日志>#</a></h3>
<p>blademaster中的日志功能与其他框架类似，提供了http请求相关信息的记录，Log中间件的具体代码如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Logger is logger  middleware
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Logger</span>() <span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>noUser</span> = <span style=color:#e6db74>&#34;no_user&#34;</span>
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
		<span style=color:#75715e>// 获取执行剩余handler前的信息
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
		<span style=color:#a6e22e>req</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>
		<span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>
		<span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Form</span>
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>quota</span> <span style=color:#66d9ef>float64</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>deadline</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>.<span style=color:#a6e22e>Deadline</span>(); <span style=color:#a6e22e>ok</span> {
			<span style=color:#a6e22e>quota</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>deadline</span>).<span style=color:#a6e22e>Seconds</span>()
		}
		<span style=color:#75715e>// 执行剩余handler
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()

		<span style=color:#75715e>// 获取handler执行完毕后的信息
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Error</span>
		<span style=color:#a6e22e>cerr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ecode</span>.<span style=color:#a6e22e>Cause</span>(<span style=color:#a6e22e>err</span>)
		<span style=color:#75715e>// 请求处理的时间
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>dt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>now</span>)
		<span style=color:#a6e22e>caller</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>Caller</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>caller</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
			<span style=color:#a6e22e>caller</span> = <span style=color:#a6e22e>noUser</span>
		}

		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RoutePath</span>) &gt; <span style=color:#ae81ff>0</span> {
			<span style=color:#a6e22e>_metricServerReqCodeTotal</span>.<span style=color:#a6e22e>Inc</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RoutePath</span>[<span style=color:#ae81ff>1</span>:], <span style=color:#a6e22e>caller</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Method</span>, <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>FormatInt</span>(int64(<span style=color:#a6e22e>cerr</span>.<span style=color:#a6e22e>Code</span>()), <span style=color:#ae81ff>10</span>))
			<span style=color:#a6e22e>_metricServerReqDur</span>.<span style=color:#a6e22e>Observe</span>(int64(<span style=color:#a6e22e>dt</span><span style=color:#f92672>/</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>), <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RoutePath</span>[<span style=color:#ae81ff>1</span>:], <span style=color:#a6e22e>caller</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Method</span>)
		}

		<span style=color:#a6e22e>lf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Infov</span>
		<span style=color:#a6e22e>errmsg</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;&#34;</span>
		<span style=color:#a6e22e>isSlow</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dt</span> <span style=color:#f92672>&gt;=</span> (<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>500</span>)
		<span style=color:#75715e>// 通过是否有错误和处理时间是否过长来决定是不是使用warn级别的日志输出
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>errmsg</span> = <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()
			<span style=color:#a6e22e>lf</span> = <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Errorv</span>
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cerr</span>.<span style=color:#a6e22e>Code</span>() &gt; <span style=color:#ae81ff>0</span> {
				<span style=color:#a6e22e>lf</span> = <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Warnv</span>
			}
		} <span style=color:#66d9ef>else</span> {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isSlow</span> {
				<span style=color:#a6e22e>lf</span> = <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Warnv</span>
			}
		}
		<span style=color:#75715e>// 记录日志
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>lf</span>(<span style=color:#a6e22e>c</span>,
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;method&#34;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Method</span>),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;ip&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>RemoteIP</span>()),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;user&#34;</span>, <span style=color:#a6e22e>caller</span>),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#a6e22e>path</span>),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;params&#34;</span>, <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>Encode</span>()),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVInt</span>(<span style=color:#e6db74>&#34;ret&#34;</span>, <span style=color:#a6e22e>cerr</span>.<span style=color:#a6e22e>Code</span>()),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;msg&#34;</span>, <span style=color:#a6e22e>cerr</span>.<span style=color:#a6e22e>Message</span>()),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;stack&#34;</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%+v&#34;</span>, <span style=color:#a6e22e>err</span>)),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>errmsg</span>),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVFloat64</span>(<span style=color:#e6db74>&#34;timeout_quota&#34;</span>, <span style=color:#a6e22e>quota</span>),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVFloat64</span>(<span style=color:#e6db74>&#34;ts&#34;</span>, <span style=color:#a6e22e>dt</span>.<span style=color:#a6e22e>Seconds</span>()),
			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>KVString</span>(<span style=color:#e6db74>&#34;source&#34;</span>, <span style=color:#e6db74>&#34;http-access-log&#34;</span>),
		)
	}
}
</code></pre></td></tr></table>
</div>
</div><p>这个方法在handler开始处理前后记录时间，用户等想关元信息，根据处理结果是否出错以及处理时间是否过长来决定日志的输出级别。</p>
<h3 id=25-trace>2.5 Trace<a hidden class=anchor aria-hidden=true href=#25-trace>#</a></h3>
<p>blademaster中Trace信息的记录方式同日志信息一样，其实现代码如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Trace is trace middleware
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Trace</span>() <span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
		<span style=color:#75715e>// 从http request header 中获取trace信息
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Extract</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>HTTPFormat</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Header</span>)
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>opts</span> []<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>Option</span>
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>ParseBool</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>KratosTraceDebug</span>); <span style=color:#a6e22e>ok</span> {
				<span style=color:#a6e22e>opts</span> = append(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>EnableDebug</span>())
			}
			<span style=color:#75715e>// 如果trace 信息不存在，就根据当前url创建一个trace单元
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>t</span> = <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
		}
		<span style=color:#75715e>// 设定trace信息 包含标题和tag
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetTitle</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Path</span>)
		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetTag</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>TagComponent</span>, <span style=color:#a6e22e>_defaultComponentName</span>))
		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetTag</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>TagHTTPMethod</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Method</span>))
		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetTag</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>TagHTTPURL</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>String</span>()))
		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetTag</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>TagSpanKind</span>, <span style=color:#e6db74>&#34;server&#34;</span>))
		<span style=color:#75715e>// business tag
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>SetTag</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;caller&#34;</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>Caller</span>)))

		<span style=color:#75715e>// 把trace信息加入到http header中，让用户可以查看，便于debug，同时也让下游代码可以继续记录trace信息
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Writer</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>KratosTraceID</span>, <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>TraceID</span>())
		<span style=color:#75715e>// 根据trace信息，新建一个官方包里的context
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span> = <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>NewContext</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>t</span>)
		<span style=color:#75715e>// 调用剩余的handler
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()
		<span style=color:#75715e>// 标记trace信息已经完成
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Finish</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Error</span>)
	}
}
</code></pre></td></tr></table>
</div>
</div><p>要记录trace信息，blademaster首先尝试从当前http request header中获取已经存在trace信息，如果trace信息不存在，说明这是链路调用的开始，就依据当前请求信息新建一个Trace单元。同样的，在handler执行前后，记录相关信息到trace单元中，然后将trace信息存放在<strong>http response header</strong>中，方便下游系统处理。trace信息中比较关键的要素有：</p>
<ul>
<li>trace id</li>
<li>url地址</li>
<li>业务模块相关的信息</li>
<li>处理结果信息</li>
</ul>
<h3 id=26-recovery>2.6 Recovery<a hidden class=anchor aria-hidden=true href=#26-recovery>#</a></h3>
<p>上面已经讨论过，blademaster使用的一个请求一个goroutine的IO模型，如果goroutine出现panic怎么办？这时候u需要把错误信息传递给调用方，但是panic会导致整个进程挂掉，这显然是不合理的，blademaster的recovery中间件就是用来<strong>将panic信息转化为http 500的错误信息</strong>，即保证进程运行，也把错误信息返回给客户端，类似于Spring中的Global Exception Handler。其实现代码如下：</p>
<div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// Recovery returns a middleware that recovers from any panics and writes a 500 if there was one.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Recovery</span>() <span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Context</span>) {
		<span style=color:#75715e>// 通过defer方法从panic中恢复
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>rawReq</span> []<span style=color:#66d9ef>byte</span>
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> recover(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>size</span> = <span style=color:#ae81ff>64</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>10</span>
				<span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>size</span>)
				<span style=color:#75715e>// 获取出错的栈帧信息
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>buf</span> = <span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Stack</span>(<span style=color:#a6e22e>buf</span>, <span style=color:#66d9ef>false</span>)]
				<span style=color:#75715e>// 获取出错的http请求的详细信息
</span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
					<span style=color:#a6e22e>rawReq</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>httputil</span>.<span style=color:#a6e22e>DumpRequest</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#66d9ef>false</span>)
				}
				<span style=color:#a6e22e>pl</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;http call panic: %sn%vn%sn&#34;</span>, string(<span style=color:#a6e22e>rawReq</span>), <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>buf</span>)
				<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stderr</span>, <span style=color:#a6e22e>pl</span>)
				<span style=color:#75715e>// 记录错误日志
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>pl</span>)
				<span style=color:#75715e>// 返回500错误信息
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#ae81ff>500</span>)
			}
		}()
		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()
	}
}
</code></pre></td></tr></table>
</div>
</div><p>从上述代码中可以看到，Recovery中间件<code>recovery()</code>函数从panic中恢复，并返回给客户端错误信息，这也意味着Recovery中间件应该放在所有中间件的<strong>最前面</strong>。</p>
<h2 id=3-总结>3 总结<a hidden class=anchor aria-hidden=true href=#3-总结>#</a></h2>
<p>本文讨论kratos blademaster模块的一些实现细节，可以看出，得益与职责链模式的使用，中间件的扩展非常灵活。</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://tianyuxue.github.io/tags/http/>http</a></li>
<li><a href=https://tianyuxue.github.io/tags/kratos/>kratos</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://tianyuxue.github.io/posts/ovs-learing-1/>
<span class=title>« Prev Page</span>
<br>
<span>Open vSwitch学习 - 1 开发环境搭建</span>
</a>
<a class=next href=https://tianyuxue.github.io/posts/kratos-src-cache/>
<span class=title>Next Page »</span>
<br>
<span>Kratos源码分析 - 缓存部分</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://tianyuxue.github.io/>ACoder</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
<div>
<a href=https://beian.miit.gov.cn/ rel="external nofollow" target=_blank>京ICP备2021000699号</a>
</div>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>